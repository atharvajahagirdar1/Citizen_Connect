<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="editProfile">Profile Setup</title>
  <script src="../js/languageManager.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f8fafb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      width: 100%;
      max-width: 400px;
      padding: 40px 30px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }

    h2 {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 40px;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #f5f5f5;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: #fff3cd;
      transform: scale(1.05);
    }

    /* Profile Picture Section */
    .profile-pic-section {
      margin-bottom: 40px;
    }

    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid #4285f4;
      margin: 0 auto 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-pic:hover {
      transform: scale(1.05);
      border-color: #ffc107;
      background: #fff3cd;
    }

    .profile-pic input {
      display: none;
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .camera-icon {
      font-size: 32px;
      color: #6b7280;
    }

    .add-photo-btn {
      background: white;
      border: 2px solid #4285f4;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #4285f4;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .add-photo-btn:hover {
      background: #fff3cd;
      border-color: #ffc107;
      color: #333;
      transform: translateY(-2px);
    }

    /* Form Inputs */
    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      background: white;
      transition: all 0.3s ease;
      outline: none;
    }

    .form-input:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-input:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .form-select {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 16px center;
      background-repeat: no-repeat;
      background-size: 16px;
    }

    .form-select:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-select:hover {
      border-color: #ffc107;
      background-color: #fff3cd;
    }



    /* Save Button */
    .save-btn {
      width: 100%;
      padding: 16px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
    }

    .save-btn:hover {
      background: #fff3cd;
      color: #333;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .save-btn:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Validation */
    .error {
      border-color: #ef4444 !important;
    }

    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
    }

    /* Success state */
    .success {
      border-color: #10b981 !important;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        margin: 20px;
        padding: 30px 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-button" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <h2 data-translate="editProfile">Complete Your Profile</h2>

    <!-- Profile Picture Section -->
    <div class="profile-pic-section">
      <label class="profile-pic" for="profileUpload">
        <input type="file" accept="image/*" id="profileUpload" onchange="previewImage(event)">
        <img id="profileImage" src="" alt="" style="display: none;">
        <div class="camera-icon" id="cameraIcon">üì∑</div>
      </label>
      <label for="profileUpload" class="add-photo-btn">
        + <span data-translate="editProfile">Add Photo</span>
      </label>
    </div>

    <!-- Full Name -->
    <div class="form-group">
      <label class="form-label" data-translate="fullName">Full Name</label>
      <input type="text" class="form-input" id="fullName" data-translate-placeholder="enterFullName" placeholder="Enter your full name" required>
      <div class="error-message" id="nameError"></div>
    </div>

    <!-- Role Selection -->
    <div class="form-group">
      <label class="form-label" data-translate="role">Role</label>
      <select class="form-select" id="roleSelect" required>
        <option value="" data-translate="selectRole">Select your role</option>
        <option value="citizen" data-translate="citizen">Citizen</option>
        <option value="volunteer" data-translate="volunteer">Volunteer</option>
        <option value="worker" data-translate="municipalWorker">Municipal Worker</option>
      </select>
      <div class="error-message" id="roleError"></div>
    </div>

    <!-- Language Selection -->
    <div class="form-group">
      <label class="form-label" data-translate="language">Preferred Language (Optional)</label>
      <select class="form-select" id="languageSelect">
        <option value="" data-translate="selectLanguage">Select your preferred language</option>
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
      </select>
    </div>

    <!-- Save Button -->
    <button class="save-btn" id="saveBtn" onclick="saveProfile()">
      <span data-translate="save">Save</span> & <span data-translate="next">Continue</span>
    </button>
  </div>

  <script>
    let selectedLanguage = 'en';
    let profileImageData = null;
    let languageManager;

    // Initialize language manager
    function initializeLanguageManager() {
      try {
        if (typeof window.languageManager !== 'undefined') {
          languageManager = window.languageManager;
          console.log('Using existing language manager instance');
          
          // Apply translations to the page
          languageManager.updatePageTranslations();
          
          // Set the initial selected language in dropdown
          const currentLang = languageManager.getCurrentLanguage();
          selectedLanguage = currentLang;
          
          // Update dropdown selection
          const languageSelect = document.getElementById('languageSelect');
          if (languageSelect) {
            languageSelect.value = currentLang;
          }
          
          return true;
        } else {
          console.warn('LanguageManager not available, creating fallback');
          // Create fallback language manager
          window.languageManager = {
            t: function(key) { return key; },
            getCurrentLanguage: function() { return selectedLanguage || 'en'; },
            setLanguage: function(lang) { 
              selectedLanguage = lang;
              localStorage.setItem('selectedLanguage', lang); 
            },
            updatePageTranslations: function() {
              console.log('Fallback translation update');
            }
          };
          languageManager = window.languageManager;
          return false;
        }
      } catch (error) {
        console.error('Error initializing language manager:', error);
        // Create minimal fallback
        window.languageManager = {
          t: function(key) { return key; },
          getCurrentLanguage: function() { return selectedLanguage || 'en'; },
          setLanguage: function(lang) { 
            selectedLanguage = lang;
            localStorage.setItem('selectedLanguage', lang); 
          },
          updatePageTranslations: function() {}
        };
        languageManager = window.languageManager;
        return false;
      }
    }

    // Preview uploaded profile picture
    function previewImage(event) {
      try {
        const file = event.target.files[0];
        if (!file) {
          console.log('No file selected');
          return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image file is too large. Please select an image smaller than 5MB.');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function () {
          try {
            const output = document.getElementById('profileImage');
            const cameraIcon = document.getElementById('cameraIcon');
            
            if (output && cameraIcon) {
              output.src = reader.result;
              output.style.display = 'block';
              cameraIcon.style.display = 'none';
              profileImageData = reader.result;
              
              // Add success styling
              const profilePic = document.querySelector('.profile-pic');
              if (profilePic) {
                profilePic.classList.add('success');
              }
              
              console.log('Profile image preview updated');
            }
          } catch (error) {
            console.error('Error updating image preview:', error);
            alert('Error processing the image. Please try a different image.');
          }
        };
        
        reader.onerror = function() {
          console.error('Error reading file');
          alert('Error reading the image file. Please try again.');
        };
        
        reader.readAsDataURL(file);
      } catch (error) {
        console.error('Error in previewImage function:', error);
        alert('An error occurred while processing the image. Please try again.');
      }
    }

    // Language selection
    function setupLanguageSelection() {
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', function() {
          selectedLanguage = this.value || 'en';
          
          // Update language manager if available
          if (languageManager) {
            try {
              languageManager.setLanguage(selectedLanguage);
              if (typeof languageManager.updatePageTranslations === 'function') {
                languageManager.updatePageTranslations();
              } else if (typeof languageManager.applyTranslations === 'function') {
                languageManager.applyTranslations();
              }
              console.log('Language changed to:', selectedLanguage);
            } catch (error) {
              console.error('Error changing language:', error);
            }
          } else {
            // Store language preference even without language manager
            localStorage.setItem('selectedLanguage', selectedLanguage);
            console.log('Language preference stored:', selectedLanguage);
          }
        });
        
        // Set initial value from stored preference
        const storedLanguage = localStorage.getItem('selectedLanguage');
        if (storedLanguage) {
          languageSelect.value = storedLanguage;
          selectedLanguage = storedLanguage;
        }
      }
    }

    // Form validation
    function validateForm() {
      let isValid = true;
      
      try {
        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.querySelectorAll('.form-input, .form-select').forEach(el => el.classList.remove('error'));
        
        // Validate name
        const fullNameInput = document.getElementById('fullName');
        const fullName = fullNameInput ? fullNameInput.value.trim() : '';
        if (!fullName || fullName.length < 2) {
          if (fullNameInput) {
            fullNameInput.classList.add('error');
          }
          const nameErrorEl = document.getElementById('nameError');
          const errorMessage = (languageManager && typeof languageManager.t === 'function') ? 
            languageManager.t('enterFullNameError') || 'Please enter your full name (at least 2 characters)' :
            'Please enter your full name (at least 2 characters)';
          if (nameErrorEl) {
            nameErrorEl.textContent = errorMessage;
          }
          isValid = false;
        }
        
        // Validate role
        const roleSelect = document.getElementById('roleSelect');
        const role = roleSelect ? roleSelect.value : '';
        if (!role) {
          if (roleSelect) {
            roleSelect.classList.add('error');
          }
          const roleErrorEl = document.getElementById('roleError');
          const errorMessage = (languageManager && typeof languageManager.t === 'function') ? 
            languageManager.t('selectRoleError') || 'Please select your role' :
            'Please select your role';
          if (roleErrorEl) {
            roleErrorEl.textContent = errorMessage;
          }
          isValid = false;
        }
        
        return isValid;
      } catch (error) {
        console.error('Error in form validation:', error);
        return false;
      }
    }

    // Save profile and navigate to dashboard
    function saveProfile() {
      try {
        console.log('Save profile function called');
        
        if (!validateForm()) {
          console.log('Form validation failed');
          return;
        }
        
        const fullNameInput = document.getElementById('fullName');
        const roleSelect = document.getElementById('roleSelect');
        const languageSelect = document.getElementById('languageSelect');
        
        if (!fullNameInput || !roleSelect) {
          console.error('Required form elements not found');
          alert('Form elements missing. Please refresh the page and try again.');
          return;
        }
        
        const fullName = fullNameInput.value.trim();
        const role = roleSelect.value;
        const language = languageSelect ? languageSelect.value : selectedLanguage || 'en';
        
        // Validate data before saving
        if (!fullName || fullName.length < 2) {
          alert('Please enter a valid full name.');
          return;
        }
        
        if (!role) {
          alert('Please select your role.');
          return;
        }
        
        const profileData = {
          fullName: fullName,
          role: role,
          language: language,
          profileImage: profileImageData,
          setupCompleted: true,
          setupDate: new Date().toISOString(),
          lastUpdated: new Date().toISOString()
        };
        
        console.log('Profile data to save:', profileData);
        
        // Store profile data in localStorage
        try {
          localStorage.setItem('userProfile', JSON.stringify(profileData));
          console.log('Profile data saved to localStorage successfully');
          
          // Clear the new user flag since profile is now complete
          const userData = localStorage.getItem('userData');
          if (userData) {
            const user = JSON.parse(userData);
            if (user.isNewUser) {
              delete user.isNewUser;
              // Also update userData with the full name if it's not there
              if (!user.name || user.name !== fullName) {
                user.name = fullName;
              }
              localStorage.setItem('userData', JSON.stringify(user));
              console.log('Updated userData and removed new user flag');
            }
          }
          
          // Save language preference if language manager is available
          if (languageManager && typeof languageManager.setLanguage === 'function') {
            try {
              languageManager.setLanguage(language);
              console.log('Language preference applied via language manager:', language);
            } catch (error) {
              console.error('Error applying language via language manager:', error);
            }
          } else {
            // Fallback: save to localStorage directly
            localStorage.setItem('selectedLanguage', language);
            console.log('Language preference saved to localStorage:', language);
          }
          
          // Show success message
          const message = (languageManager && typeof languageManager.t === 'function') ? 
            languageManager.t('profileSavedSuccessfully') || 'Profile saved successfully! Welcome to Citizen Connect!' :
            'Profile saved successfully! Welcome to Citizen Connect!';
          
          alert(message);
          
          // Navigate to main dashboard
          console.log('Navigating to main dashboard...');
          window.location.href = '../Main UI/index.html';
          
        } catch (storageError) {
          console.error('Error saving to localStorage:', storageError);
          alert('Error saving profile data. Please check if you have enough storage space and try again.');
          return;
        }
        
      } catch (error) {
        console.error('Error in saveProfile function:', error);
        alert('An error occurred while saving your profile. Please try again.');
      }
    }

    // Check if coming from login/signup
    function checkSetupRequired() {
      const existingProfile = localStorage.getItem('userProfile');
      if (existingProfile) {
        const profile = JSON.parse(existingProfile);
        if (profile.setupCompleted) {
          // Profile already set up, redirect to dashboard
          window.location.href = '../Main UI/index.html';
          return;
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setup Profile Page - DOM Content Loaded');
      
      try {
        // Initialize language manager first
        const langManagerReady = initializeLanguageManager();
        
        // Setup language selection
        setupLanguageSelection();
        
        // Check if coming from signup and pre-fill data
        try {
          const userData = localStorage.getItem('userData');
          if (userData) {
            const user = JSON.parse(userData);
            if (user.isNewUser && user.name) {
              const fullNameInput = document.getElementById('fullName');
              if (fullNameInput) {
                fullNameInput.value = user.name;
                console.log('Pre-filled name from signup:', user.name);
              }
            }
          }
        } catch (error) {
          console.error('Error pre-filling signup data:', error);
        }
        
        // Add input event listeners for real-time validation
        const fullNameInput = document.getElementById('fullName');
        if (fullNameInput) {
          fullNameInput.addEventListener('input', function() {
            try {
              if (this.value.trim().length >= 2) {
                this.classList.remove('error');
                this.classList.add('success');
                const nameErrorEl = document.getElementById('nameError');
                if (nameErrorEl) {
                  nameErrorEl.textContent = '';
                }
              }
            } catch (error) {
              console.error('Error in name input handler:', error);
            }
          });
        }
        
        const roleSelect = document.getElementById('roleSelect');
        if (roleSelect) {
          roleSelect.addEventListener('change', function() {
            try {
              if (this.value) {
                this.classList.remove('error');
                this.classList.add('success');
                const roleErrorEl = document.getElementById('roleError');
                if (roleErrorEl) {
                  roleErrorEl.textContent = '';
                }
              }
            } catch (error) {
              console.error('Error in role select handler:', error);
            }
          });
        }
        
        console.log('Setup Profile Page - Initialization complete');
        
        // Add storage event listener for cross-page synchronization
        window.addEventListener('storage', function(event) {
          console.log('Storage event detected in Setup Profile Page:', event.key);
          if (event.key === 'userProfile' || event.key === 'userData') {
            console.log('User data changed in another tab, checking if profile setup is still needed...');
            checkSetupRequired();
          }
        });
        
      } catch (error) {
        console.error('Error during page initialization:', error);
        // Show user-friendly error message
        alert('There was an error loading the page. Please refresh and try again.');
      }
    });

    function goBack() {
      window.history.back();
    }
  </script>
</body>
</html>