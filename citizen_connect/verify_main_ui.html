<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Main UI Data Loading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <h1>üîç Verify Main UI Data Loading</h1>
    <p>This page simulates the Main UI data loading process to verify our fixes work correctly.</p>

    <div class="test-section">
        <h2>Step 1: Setup Test Data</h2>
        <button class="test-button" onclick="setupCompleteProfile()">Setup Complete Profile</button>
        <button class="test-button" onclick="setupMinimalData()">Setup Minimal Data</button>
        <button class="test-button" onclick="setupNoData()">Setup No Data (New User)</button>
        <div id="setup-status" class="status info">Ready to setup test data...</div>
    </div>

    <div class="test-section">
        <h2>Step 2: Test Main UI Loading Logic</h2>
        <button class="test-button" onclick="testMainUILogic()">Test Main UI Loading Logic</button>
        <button class="test-button" onclick="testProfilePriority()">Test Profile Priority</button>
        <button class="test-button" onclick="testErrorHandling()">Test Error Handling</button>
        <div id="test-status" class="status info">Ready to test Main UI logic...</div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results" class="result-box">No tests run yet...</div>
    </div>

    <div class="test-section">
        <h2>Current LocalStorage</h2>
        <button class="test-button" onclick="displayLocalStorage()">Display LocalStorage</button>
        <div id="localstorage-display" class="result-box">Click button to display...</div>
    </div>

    <script>
        // Simulate the Main UI loading logic
        function simulateMainUILoading() {
            try {
                console.log('=== Main UI Loading Simulation Started ===');
                
                // Clear any existing data
                let displayName = 'Unknown User';
                let displayRole = 'User';
                let profileImage = null;
                let dataSource = 'none';
                
                // Try to load userProfile first (higher priority)
                const userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    try {
                        const profileData = JSON.parse(userProfile);
                        console.log('‚úÖ Found userProfile:', profileData);
                        
                        // Extract display name with multiple field name support
                        displayName = profileData.fullName || 
                                     profileData.displayName || 
                                     profileData.name || 
                                     'Unknown User';
                        
                        // Extract role with multiple field name support  
                        displayRole = profileData.role || 
                                     profileData.displayRole || 
                                     profileData.userRole || 
                                     'User';
                        
                        profileImage = profileData.profileImage || null;
                        dataSource = 'userProfile';
                        
                    } catch (error) {
                        console.error('‚ùå Error parsing userProfile:', error);
                    }
                }
                
                // Fallback to userData if no profile found
                if (dataSource === 'none') {
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const data = JSON.parse(userData);
                            console.log('‚úÖ Found userData:', data);
                            
                            displayName = data.name || 
                                         data.displayName || 
                                         data.fullName || 
                                         'Unknown User';
                            
                            displayRole = data.role || 
                                         data.userRole || 
                                         'User';
                            
                            dataSource = 'userData';
                            
                        } catch (error) {
                            console.error('‚ùå Error parsing userData:', error);
                        }
                    }
                }
                
                console.log(`üìä Final result: ${displayName} (${displayRole}) from ${dataSource}`);
                
                return {
                    displayName,
                    displayRole,
                    profileImage,
                    dataSource,
                    success: true
                };
                
            } catch (error) {
                console.error('‚ùå Main UI loading simulation failed:', error);
                return {
                    displayName: 'Unknown User',
                    displayRole: 'User',
                    profileImage: null,
                    dataSource: 'error',
                    success: false,
                    error: error.message
                };
            }
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function addResult(message) {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `[${timestamp}] ${message}<br>`;
        }

        function setupCompleteProfile() {
            try {
                const completeProfile = {
                    fullName: "John Citizen",
                    role: "community_volunteer",
                    language: "en",
                    profileImage: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SkM8L3RleHQ+PC9zdmc+",
                    setupCompleted: true,
                    setupDate: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };

                const userData = {
                    email: "john@example.com",
                    name: "John Old Name",
                    loginDate: new Date().toISOString()
                };

                localStorage.setItem('userProfile', JSON.stringify(completeProfile));
                localStorage.setItem('userData', JSON.stringify(userData));

                updateStatus('setup-status', '‚úÖ Complete profile setup finished', 'success');
                addResult('‚úÖ Setup complete: Profile with userData fallback');
                displayLocalStorage();
                
            } catch (error) {
                updateStatus('setup-status', `‚ùå Setup failed: ${error.message}`, 'error');
            }
        }

        function setupMinimalData() {
            try {
                const minimalData = {
                    name: "Jane Minimal",
                    email: "jane@example.com",
                    loginDate: new Date().toISOString()
                };

                localStorage.setItem('userData', JSON.stringify(minimalData));
                localStorage.removeItem('userProfile');

                updateStatus('setup-status', '‚úÖ Minimal data setup finished', 'success');
                addResult('‚úÖ Setup minimal: Only userData');
                displayLocalStorage();
                
            } catch (error) {
                updateStatus('setup-status', `‚ùå Setup failed: ${error.message}`, 'error');
            }
        }

        function setupNoData() {
            try {
                localStorage.clear();
                updateStatus('setup-status', '‚úÖ Storage cleared (new user scenario)', 'success');
                addResult('‚úÖ Setup cleared: No user data (simulates new user)');
                displayLocalStorage();
            } catch (error) {
                updateStatus('setup-status', `‚ùå Clear failed: ${error.message}`, 'error');
            }
        }

        function testMainUILogic() {
            try {
                const result = simulateMainUILoading();
                
                if (result.success) {
                    updateStatus('test-status', '‚úÖ Main UI logic test passed', 'success');
                    addResult(`‚úÖ Main UI logic: ${result.displayName} (${result.displayRole}) from ${result.dataSource}`);
                    
                    if (result.profileImage) {
                        addResult('‚úÖ Profile image found and loaded');
                    }
                } else {
                    updateStatus('test-status', '‚ùå Main UI logic test failed', 'error');
                    addResult(`‚ùå Main UI logic failed: ${result.error}`);
                }
                
            } catch (error) {
                updateStatus('test-status', `‚ùå Test execution failed: ${error.message}`, 'error');
                addResult(`‚ùå Test execution error: ${error.message}`);
            }
        }

        function testProfilePriority() {
            try {
                // Test that userProfile takes priority over userData
                const profileData = {
                    fullName: "Profile Name",
                    role: "profile_role",
                    setupCompleted: true
                };

                const userData = {
                    name: "User Data Name",
                    role: "user_role"
                };

                localStorage.setItem('userProfile', JSON.stringify(profileData));
                localStorage.setItem('userData', JSON.stringify(userData));

                const result = simulateMainUILoading();
                
                if (result.dataSource === 'userProfile' && 
                    result.displayName === 'Profile Name' && 
                    result.displayRole === 'profile_role') {
                    
                    updateStatus('test-status', '‚úÖ Profile priority test passed', 'success');
                    addResult('‚úÖ Profile priority: userProfile correctly takes precedence');
                } else {
                    updateStatus('test-status', '‚ùå Profile priority test failed', 'error');
                    addResult(`‚ùå Profile priority failed: Expected userProfile data, got ${result.dataSource}`);
                }
                
            } catch (error) {
                updateStatus('test-status', `‚ùå Priority test failed: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            try {
                // Test with corrupted data
                localStorage.setItem('userProfile', 'invalid json {');
                localStorage.setItem('userData', '{"name": "Valid User"}');

                const result = simulateMainUILoading();
                
                if (result.dataSource === 'userData' && result.displayName === 'Valid User') {
                    updateStatus('test-status', '‚úÖ Error handling test passed', 'success');
                    addResult('‚úÖ Error handling: Gracefully handled corrupted profile data');
                } else {
                    updateStatus('test-status', '‚ùå Error handling test failed', 'error');
                    addResult('‚ùå Error handling: Failed to handle corrupted data properly');
                }
                
            } catch (error) {
                updateStatus('test-status', `‚ùå Error handling test failed: ${error.message}`, 'error');
            }
        }

        function displayLocalStorage() {
            try {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    try {
                        data[key] = JSON.parse(value);
                    } catch {
                        data[key] = value;
                    }
                }
                document.getElementById('localstorage-display').textContent = 
                    JSON.stringify(data, null, 2) || 'No data in localStorage';
            } catch (error) {
                document.getElementById('localstorage-display').textContent = 
                    `Error reading localStorage: ${error.message}`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            displayLocalStorage();
            addResult('üöÄ Main UI verification page initialized');
        });
    </script>
</body>
</html>