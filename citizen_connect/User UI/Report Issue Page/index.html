<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Issue - Citizen Connect</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f8fafb;
      color: #1a1a1a;
      min-height: 100vh;
    }

    .container {
      max-width: 430px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      padding: 50px 20px 30px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-button {
      background: #f5f5f5;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 15px;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: #fff3cd;
      transform: scale(1.05);
    }

    .header-title {
      flex: 1;
      font-size: 22px;
      font-weight: 700;
      color: #1a1a1a;
    }

    /* Content */
    .content {
      padding: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Photo preview */
    .photo-preview {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 24px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .photo-preview:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .preview-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .photo-container {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      aspect-ratio: 4/3;
      border-radius: 12px;
      overflow: hidden;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-placeholder {
      font-size: 48px;
      color: #9ca3af;
    }

    /* Location info */
    .location-info {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 24px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .location-info:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .location-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .location-value {
      font-size: 16px;
      color: #1a1a1a;
      font-weight: 500;
      line-height: 1.4;
    }

    /* Form inputs */
    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .form-select, .form-textarea {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      background: white;
      transition: all 0.3s ease;
      outline: none;
      font-family: inherit;
    }

    .form-select:focus, .form-textarea:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-select:hover, .form-textarea:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 16px center;
      background-repeat: no-repeat;
      background-size: 16px;
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }

    /* Priority selection */
    .priority-options {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .priority-option {
      flex: 1;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .priority-option:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .priority-option.selected {
      border-color: #4285f4;
      background: #4285f4;
      color: white;
    }

    .priority-emoji {
      font-size: 20px;
      margin-bottom: 4px;
      display: block;
    }

    .priority-text {
      font-size: 12px;
      font-weight: 600;
    }

    /* Submit button */
    .submit-button {
      width: 100%;
      padding: 18px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.3);
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-button:hover {
      background: #fff3cd;
      color: #333;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .submit-button:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Loading state */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error state */
    .error {
      border-color: #dc3545 !important;
    }

    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #f8d7da;
      border-radius: 8px;
      border: 1px solid #f5c6cb;
    }

    /* Responsive */
    @media (max-width: 430px) {
      .container {
        max-width: 100%;
      }
      
      .header {
        padding: 40px 15px 25px 15px;
      }
      
      .content {
        padding: 15px;
      }
      
      .priority-options {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="back-button" onclick="goBack()">‚Üê</button>
      <div class="header-title">Report Issue</div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="section-title">
        üìã Issue Details
      </div>

      <!-- Photo Preview -->
      <div class="photo-preview">
        <div class="preview-label">üì∑ Captured Photo</div>
        <div class="photo-container" id="photoContainer">
          <div class="photo-placeholder">üì∑</div>
        </div>
      </div>

      <!-- Location Info -->
      <div class="location-info" id="locationInfo">
        <div class="location-label">üìç Location</div>
        <div class="location-value" id="locationValue">Loading location...</div>
      </div>

      <!-- Issue Category -->
      <div class="form-group">
        <label class="form-label">üè∑Ô∏è Issue Category</label>
        <select class="form-select" id="categorySelect" required>
          <option value="">Select issue category</option>
          <option value="pothole">üï≥Ô∏è Potholes & Road Damage</option>
          <option value="streetlight">üí° Street Lighting</option>
          <option value="garbage">üóëÔ∏è Garbage & Waste</option>
          <option value="water">üíß Water & Drainage</option>
          <option value="traffic">üö¶ Traffic & Signals</option>
          <option value="sidewalk">üö∂ Sidewalks & Walkways</option>
          <option value="park">üå≥ Parks & Recreation</option>
          <option value="noise">üîä Noise Pollution</option>
          <option value="other">üìù Other</option>
        </select>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label class="form-label">üìù Description</label>
        <textarea 
          class="form-textarea" 
          id="descriptionText" 
          placeholder="Describe the issue in detail. Include any relevant information that might help resolve it faster."
          required
        ></textarea>
      </div>

      <!-- Priority -->
      <div class="form-group">
        <label class="form-label">‚ö° Priority Level</label>
        <div class="priority-options">
          <div class="priority-option" onclick="selectPriority('low')" data-priority="low">
            <span class="priority-emoji">üü¢</span>
            <span class="priority-text">Low</span>
          </div>
          <div class="priority-option" onclick="selectPriority('medium')" data-priority="medium">
            <span class="priority-emoji">üü°</span>
            <span class="priority-text">Medium</span>
          </div>
          <div class="priority-option" onclick="selectPriority('high')" data-priority="high">
            <span class="priority-emoji">üî¥</span>
            <span class="priority-text">High</span>
          </div>
          <div class="priority-option" onclick="selectPriority('urgent')" data-priority="urgent">
            <span class="priority-emoji">üö®</span>
            <span class="priority-text">Urgent</span>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <button class="submit-button" onclick="submitReport()" id="submitBtn">
        üì§ Submit Report
      </button>
    </div>
  </div>

  <script>
    let selectedPriority = 'medium'; // Default priority
    let capturedPhoto = null;
    let locationData = null;

    // Load captured photo and location data
    function loadReportData() {
      try {
        // Load captured photo
        capturedPhoto = localStorage.getItem('capturedPhoto');
        if (capturedPhoto) {
          const photoContainer = document.getElementById('photoContainer');
          photoContainer.innerHTML = `<img src="${capturedPhoto}" alt="Captured issue photo">`;
        }

        // Load location data
        const locationStr = localStorage.getItem('reportedIssueLocation');
        const locationDataStr = localStorage.getItem('reportLocation');
        
        if (locationDataStr) {
          locationData = JSON.parse(locationDataStr);
        }
        
        if (locationStr) {
          document.getElementById('locationValue').textContent = locationStr;
        } else {
          document.getElementById('locationValue').textContent = 'Location not available';
        }

        console.log('Report data loaded successfully');
      } catch (error) {
        console.error('Error loading report data:', error);
        alert('Error loading report data. Please try again.');
      }
    }

    // Select priority level
    function selectPriority(priority) {
      // Remove previous selection
      document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Select new priority
      const option = document.querySelector(`[data-priority="${priority}"]`);
      if (option) {
        option.classList.add('selected');
        selectedPriority = priority;
      }
    }

    // Validate form
    function validateForm() {
      console.log('üîç Starting form validation...');
      console.log('- capturedPhoto:', capturedPhoto ? '‚úÖ Available' : '‚ùå Missing');
      
      let isValid = true;
      
      // Clear previous errors
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
      document.querySelectorAll('.error-message').forEach(el => el.remove());

      // Validate category
      const categorySelect = document.getElementById('categorySelect');
      console.log('- Category value:', categorySelect.value || '‚ùå Empty');
      if (!categorySelect.value) {
        categorySelect.classList.add('error');
        showFieldError(categorySelect, 'Please select an issue category');
        isValid = false;
        console.log('‚ùå Category validation failed');
      } else {
        console.log('‚úÖ Category validation passed');
      }

      // Validate description
      const descriptionText = document.getElementById('descriptionText');
      const description = descriptionText.value.trim();
      console.log('- Description length:', description.length, 'characters');
      if (!description || description.length < 10) {
        descriptionText.classList.add('error');
        showFieldError(descriptionText, 'Please provide a detailed description (at least 10 characters)');
        isValid = false;
        console.log('‚ùå Description validation failed');
      } else {
        console.log('‚úÖ Description validation passed');
      }

      // Validate photo
      if (!capturedPhoto) {
        alert('No photo found. Please go back and capture a photo first.');
        isValid = false;
        console.log('‚ùå Photo validation failed');
      } else {
        console.log('‚úÖ Photo validation passed');
      }

      console.log('‚úÖ Form validation result:', isValid);
      return isValid;
    }

    // Show field error
    function showFieldError(field, message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      field.parentNode.appendChild(errorDiv);
    }

    // Submit report
    function submitReport() {
      console.log('üöÄ submitReport function called');
      
      if (!validateForm()) {
        console.log('‚ùå Form validation failed');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const categorySelect = document.getElementById('categorySelect');
      const descriptionText = document.getElementById('descriptionText');

      console.log('üìã Form elements found:');
      console.log('- submitBtn:', submitBtn ? '‚úÖ' : '‚ùå');
      console.log('- categorySelect:', categorySelect ? '‚úÖ' : '‚ùå');
      console.log('- descriptionText:', descriptionText ? '‚úÖ' : '‚ùå');

      try {
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        submitBtn.innerHTML = '<div class="spinner"></div> Submitting...';
        
        console.log('‚è≥ Loading state applied');

        // Prepare report data
        console.log('üìä Preparing report data...');
        console.log('- Category:', categorySelect.value);
        console.log('- Description:', descriptionText.value.trim());
        console.log('- Priority:', selectedPriority);
        console.log('- Location:', document.getElementById('locationValue').textContent);
        console.log('- LocationData:', locationData);
        console.log('- Photo available:', capturedPhoto ? '‚úÖ' : '‚ùå');

        const reportData = {
          id: 'issue_' + Date.now(),
          category: categorySelect.value,
          description: descriptionText.value.trim(),
          priority: selectedPriority,
          location: document.getElementById('locationValue').textContent,
          locationData: locationData,
          photo: capturedPhoto,
          timestamp: new Date().toISOString(),
          status: 'Reported',
          reporter: 'Citizen User'
        };
        
        console.log('‚úÖ Report data prepared:', reportData);

        // Save to user issues
        const userIssues = JSON.parse(localStorage.getItem('userIssues') || '[]');
        userIssues.push(reportData);
        localStorage.setItem('userIssues', JSON.stringify(userIssues));

        // Clear temporary data
        localStorage.removeItem('capturedPhoto');
        localStorage.removeItem('reportLocation');
        localStorage.removeItem('reportedIssueLocation');
        localStorage.removeItem('photoTimestamp');

        console.log('Report submitted successfully:', reportData);

        // Navigate to success page
        setTimeout(() => {
          window.location.href = '../Report Submission Success Page/index.html';
        }, 1000);

      } catch (error) {
        console.error('Error submitting report:', error);
        
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.innerHTML = 'üì§ Submit Report';
        
        alert('Error submitting report. Please try again.');
      }
    }

    // Go back to location selection
    function goBack() {
      window.location.href = '../Location Selection Page/index.html';
    }

    // Initialize page
    window.onload = function() {
      console.log('Report Issue Page loaded');
      
      // Load report data
      loadReportData();
      
      // Set default priority
      selectPriority('medium');
      
      // Add form validation listeners
      const categorySelect = document.getElementById('categorySelect');
      const descriptionText = document.getElementById('descriptionText');
      
      if (categorySelect) {
        categorySelect.addEventListener('change', function() {
          if (this.value) {
            this.classList.remove('error');
            const errorMsg = this.parentNode.querySelector('.error-message');
            if (errorMsg) errorMsg.remove();
          }
        });
      }
      
      if (descriptionText) {
        descriptionText.addEventListener('input', function() {
          if (this.value.trim().length >= 10) {
            this.classList.remove('error');
            const errorMsg = this.parentNode.querySelector('.error-message');
            if (errorMsg) errorMsg.remove();
          }
        });
      }
    };
  </script>
</body>
</html>